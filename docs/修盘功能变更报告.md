# 修盘（grid）数据接入变更报告

## 1. 需求背景

客户希望把“修盘数据”从数据库中读取并在界面展示，以便后续分析；本次实现以数据库 `grid` 表为数据源，并在前端新增“修盘数据”页面进行筛选/展示，同时复用已有“修盘效果分析”接口进行图表展示。

## 2. 数据来源（数据库）

数据来自 `grid` 表（见 `数据库备份\\江西\\olam_demo_250411.sql`），表结构关键字段如下：

- `id`：修盘记录主键
- `device_id`：设备编号
- `grid_mod`：修盘方式（数值）
- `set_round`：设置圈数
- `start_time` / `end_time`：开始/结束时间
- `round_num`：圈数
- `end_way`：结束方式

## 3. 后端改动（olam_api_server）

### 3.1 新增接口：查询修盘记录

- 接口：`GET /api/grid`
- 代码位置：`olam_api_server/app.py`（函数 `get_grid_records`）
- 支持参数（QueryString）：
  - `deviceId`：设备ID（可选）
  - `gridMod`：修盘方式（可选，整数）；同时兼容旧参数名 `repairMethod`
  - `startDate` / `endDate`：按 `start_time` 的日期过滤（可选，格式 `YYYY-MM-DD`）
  - `limit`：返回条数（可选，默认 200，范围 1~1000）
  - `offset`：偏移量（可选，默认 0）
- 返回字段（JSON 数组，每条记录一行）：
  - `id, device_id, grid_mod, set_round, start_time, end_time, round_num, end_way`
  - `duration_seconds`：后端计算的时长（秒），当 `start_time/end_time` 为空时返回 `null`

### 3.2 新增接口：下拉选项

- 接口：`GET /api/grid/options`
- 用途：给前端下拉框提供 `grid_mod`、`end_way` 的去重列表
- 返回：
  - `gridMods: number[]`
  - `endWays: number[]`

### 3.3 复用/增强分析接口（修盘后质量变化）

- 接口：`GET /api/analysis/repair-effect`
- 用途：按 `deviceId + repairMethod(grid_mod)` 统计修盘后“第 N 盘(批次)”的 `stdev` 变化（通过修盘时间与设备正常研磨批次时间线结合，直到下一次修盘为止）
- 新增参数：
  - `maxBatches`：最多统计到修盘后的第 N 盘（默认 30，范围 1~200）

补充：为了让前端能“选中某条修盘记录后分析”，接口也支持直接传 `gridId`：

- `gridId`：修盘记录 ID（传入后将优先按该次修盘分析；通常配合默认 `maxBatches=10`）

## 4. 供客户研发二次开发的改动指南（后端）

### 4.1 要增加返回字段

在 `GET /api/grid` 的 SQL `SELECT` 中追加列即可，例如要增加更多派生字段：

- 追加列：`EXTRACT(EPOCH FROM (g.end_time - g.start_time))/60.0 AS duration_minutes`
- 前端对应新增表格列即可展示

### 4.2 要增加筛选条件

步骤：

1. 在 `get_grid_records()` 里读取参数（`request.args.get(...)`）
2. 往 `conditions/params` 追加条件（参数化，避免 SQL 注入）
3. 前端 `Grid.vue` 里把参数加入请求即可联动

### 4.3 要做分页

该接口已支持 `limit/offset`，前端只需增加分页控件并在翻页时传 `offset = (page-1)*pageSize`。

## 5. 本次版本信息

- 后端提交：`750f8d9 feat: add grid(修盘) query api`
